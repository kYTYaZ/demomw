/*
 * FilePondPluginImageTransform 3.0.1
 * Licensed under MIT, https://opensource.org/licenses/MIT
 * Please visit https://pqina.nl/filepond for details.
 */
const isImage=t=>/^image/.test(t.type),transforms={1:()=>[1,0,0,1,0,0],2:t=>[-1,0,0,1,t,0],3:(t,e)=>[-1,0,0,-1,t,e],4:(t,e)=>[1,0,0,-1,0,e],5:()=>[0,1,1,0,0,0],6:(t,e)=>[0,1,-1,0,e,0],7:(t,e)=>[0,-1,-1,0,e,t],8:t=>[0,-1,1,0,0,t]},fixImageOrientation=(t,e,a,i)=>{-1!==i&&t.transform(...transforms[i](e,a))},createVector=(t,e)=>({x:t,y:e}),vectorDot=(t,e)=>t.x*e.x+t.y*e.y,vectorSubtract=(t,e)=>createVector(t.x-e.x,t.y-e.y),vectorDistanceSquared=(t,e)=>vectorDot(vectorSubtract(t,e),vectorSubtract(t,e)),vectorDistance=(t,e)=>Math.sqrt(vectorDistanceSquared(t,e)),getOffsetPointOnEdge=(t,e)=>{const a=t,i=e,n=1.5707963267948966-e,o=Math.sin(1.5707963267948966),r=Math.sin(i),h=Math.sin(n),s=Math.cos(n),g=a/o;return createVector(s*(g*r),s*(g*h))},getRotatedRectSize=(t,e)=>{const a=t.width,i=t.height,n=getOffsetPointOnEdge(a,e),o=getOffsetPointOnEdge(i,e),r=createVector(t.x+Math.abs(n.x),t.y-Math.abs(n.y)),h=createVector(t.x+t.width+Math.abs(o.y),t.y+Math.abs(o.x)),s=createVector(t.x-Math.abs(o.y),t.y+t.height-Math.abs(o.x));return{width:vectorDistance(r,h),height:vectorDistance(r,s)}},getImageRectZoomFactor=(t,e,a=0,i={x:.5,y:.5})=>{const n=i.x>.5?1-i.x:i.x,o=i.y>.5?1-i.y:i.y,r=2*n*t.width,h=2*o*t.height,s=getRotatedRectSize(e,a);return Math.max(s.width/r,s.height/h)},getCenteredCropRect=(t,e)=>{let a=t.width,i=a*e;i>t.height&&(a=(i=t.height)/e);return{x:.5*(t.width-a),y:.5*(t.height-i),width:a,height:i}},calculateCanvasSize=(t,e,a=1)=>{const i=t.height/t.width;let n=e,o=1,r=i;r>n&&(o=(r=n)/i);const h=Math.max(1/o,n/r),s=t.width/(a*o*h),g=s*e;return{width:Math.round(s),height:Math.round(g)}},isFlipped=t=>t&&(t.horizontal||t.vertical),getBitmap=(t,e,a)=>{if(!e&&!isFlipped(a))return t.width=t.naturalWidth,t.height=t.naturalHeight,t;const i=document.createElement("canvas"),n=t.naturalWidth,o=t.naturalHeight;e>=5&&e<=8?(i.width=o,i.height=n):(i.width=n,i.height=o);const r=i.getContext("2d");return e&&(r.save(),fixImageOrientation(r,n,o,e),r.restore()),isFlipped(a)&&(r.translate(.5*i.width,.5*i.height),r.scale(a.horizontal?-1:1,a.vertical?-1:1),r.translate(.5*-i.width,.5*-i.height)),r.drawImage(t,0,0,n,o),i},imageToImageData=(t,e,a={})=>{const i=getBitmap(t,e,a.flip),n={width:i.width,height:i.height},o=document.createElement("canvas"),r=a.aspectRatio||n.height/n.width,h=calculateCanvasSize(n,r,a.zoom);o.width=h.width,o.height=h.height;const s={x:.5*o.width,y:.5*o.height},g={x:s.x-n.width*(a.center?a.center.x:.5),y:s.y-n.height*(a.center?a.center.y:.5)},l={x:0,y:0,width:o.width,height:o.height,center:s},c=getImageRectZoomFactor(n,getCenteredCropRect(l,r),a.rotation,a.center),d=(a.zoom||1)*c,m=o.getContext("2d");return m.translate(s.x,s.y),m.rotate(a.rotation||0),m.scale(d,d),m.drawImage(i,g.x-s.x,g.y-s.y,n.width,n.height),m.getImageData(0,0,o.width,o.height)},cropSVG=(t,e)=>new Promise((a,i)=>{const n=new FileReader;n.onloadend=(()=>{const i=n.result,o=document.createElement("div");o.style.cssText="position:absolute;pointer-events:none;width:0;height:0;visibility:hidden;",o.innerHTML=i;const r=o.querySelector("svg");document.body.appendChild(o);const h=r.getBBox();o.parentNode.removeChild(o);const s=o.querySelector("title"),g=r.getAttribute("viewBox")||"",l=r.getAttribute("width")||"",c=r.getAttribute("height")||"";let d=parseFloat(l)||null,m=parseFloat(c)||null;const u=(l.match(/[a-z]+/)||[])[0]||"",p=(c.match(/[a-z]+/)||[])[0]||"",w=g.split(" ").map(parseFloat),x=w.length?{x:w[0],y:w[1],width:w[2],height:w[3]}:h;let y=null!=d?d:x.width,f=null!=m?m:x.height;r.style.overflow="visible",r.setAttribute("width",y),r.setAttribute("height",f);const v=e.aspectRatio||f/y,M=y,T=M*v,b=getImageRectZoomFactor({width:y,height:f},getCenteredCropRect({width:M,height:T},v),e.rotation,e.center),I=e.zoom*b,R=e.rotation*(180/Math.PI),$={x:.5*M,y:.5*T},E={x:$.x-y*e.center.x,y:$.y-f*e.center.y},_=[`rotate(${R} ${$.x} ${$.y})`,`translate(${$.x} ${$.y})`,`scale(${I})`,`translate(${-$.x} ${-$.y})`,`translate(${E.x} ${E.y})`],O=[`scale(${e.flip.horizontal?-1:1} ${e.flip.vertical?-1:1})`,`translate(${e.flip.horizontal?-y:0} ${e.flip.vertical?-f:0})`],F=`<?xml version="1.0" encoding="UTF-8"?>\n<svg width="${M}${u}" height="${T}${p}" \nviewBox="0 0 ${M} ${T}" \npreserveAspectRatio="xMinYMin"\nxmlns="http://www.w3.org/2000/svg">\n\x3c!-- Generator: FilePond Image Transform Plugin - https://pqina.nl/filepond --\x3e\n<title>${s?s.textContent:t.name}</title>\n<desc>Cropped with FilePond.</desc>\n<g transform="${_.join(" ")}">\n<g transform="${O.join(" ")}">\n${r.outerHTML}\n</g>\n</g>\n</svg>`;a(F)}),n.readAsText(t)}),imageDataToBlob=(t,e)=>new Promise((a,i)=>{const n=document.createElement("canvas");n.width=t.width,n.height=t.height;n.getContext("2d").putImageData(t,0,0),n.toBlob(a,e.type,e.quality)}),objectToImageData=t=>{let e;try{e=new ImageData(t.width,t.height)}catch(a){e=document.createElement("canvas").getContext("2d").createImageData(t.width,t.height)}return e.data.set(t.data),e},TransformWorker=()=>{const t={resize:function(t,e){const{mode:a,upscale:i}=e;let{width:n,height:o}=e.size;if(null===n?n=o:null===o&&(o=n),"force"!==a){let e=n/t.width,r=o/t.height,h=1;if("cover"===a?h=Math.max(e,r):"contain"===a&&(h=Math.min(e,r)),h>1&&!1===i)return t;n=t.width*h,o=t.height*h}const r=t.width,h=t.height,s=Math.round(n),g=Math.round(o);for(var l=t.data,c=new Uint8ClampedArray(s*g*4),d=r/s,m=h/g,u=Math.ceil(d/2),p=Math.ceil(m/2),w=0;w<g;w++)for(var x=0;x<s;x++){for(var y=4*(x+w*s),f=0,v=0,M=0,T=gx_g=gx_b=gx_a=0,b=(w+.5)*m,I=Math.floor(w*m);I<(w+1)*m;I++)for(var R=Math.abs(b-(I+.5))/p,$=(x+.5)*d,E=R*R,_=Math.floor(x*d);_<(x+1)*d;_++){var O=Math.abs($-(_+.5))/u,F=Math.sqrt(E+O*O);F>=-1&&F<=1&&(f=2*F*F*F-3*F*F+1)>0&&(O=4*(_+I*r),gx_a+=f*l[O+3],M+=f,l[O+3]<255&&(f=f*l[O+3]/250),T+=f*l[O],gx_g+=f*l[O+1],gx_b+=f*l[O+2],v+=f)}c[y]=T/v,c[y+1]=gx_g/v,c[y+2]=gx_b/v,c[y+3]=gx_a/M}return{data:c,width:s,height:g}}};self.onmessage=(e=>{((e,a)=>{a(((e,a)=>(e.forEach(e=>{a=t[e.type](a,e.data)}),a))(e.transforms,e.imageData))})(e.data.message,t=>{self.postMessage({id:e.data.id,message:t},[t.data.buffer])})})};HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(t,e,a){const i=this;setTimeout(()=>{const n=i.toDataURL(e,a).split(",")[1],o=atob(n);let r=o.length;const h=new Uint8Array(r);for(;r--;)h[r]=o.charCodeAt(r);t(new Blob([h],{type:e||"image/png"}))})}});var plugin$1=t=>{const{addFilter:e,utils:a}=t,{Type:i,forin:n,loadImage:o,getFileFromBlob:r,getFilenameWithoutExtension:h,createWorker:s,createBlob:g,renameFile:l,isFile:c}=a,d=["resize"];return e("PREPARE_OUTPUT",(t,{query:e,item:a})=>new Promise((i,m)=>{if(!c(t)||!isImage(t)||!e("GET_ALLOW_IMAGE_TRANSFORM"))return i(t);const u=e("GET_IMAGE_TRANSFORM_OUTPUT_QUALITY"),p=null===u?null:u/100,w=e("GET_IMAGE_TRANSFORM_OUTPUT_QUALITY_MODE"),x=e("GET_IMAGE_TRANSFORM_OUTPUT_MIME_TYPE"),{crop:y}=a.getMetadata(),f=[];if(n(a.getMetadata(),(t,e)=>{d.includes(t)&&f.push({type:t,data:e})}),(null===p||null!==p&&"optional"===w)&&null===x&&!y&&!f.length)return i(t);const v=(e,a)=>{imageDataToBlob(e,a).then(e=>{const a=r(e,((t,e)=>{return`${h(t)}.${"image/jpeg"===e?"jpg":e.split("/")[1]}`})(t.name,(t=>"image/jpeg"===t||"image/png"===t?t:"image/jpeg")(e.type)));i(a)}).catch(t=>{console.error(t)})},M=URL.createObjectURL(t);if(/svg/.test(t.type)&&null===x)return y?void cropSVG(t,y).then(e=>{i(l(g(e,"image/svg+xml"),t.name))}):i(t);o(M).then(e=>{URL.revokeObjectURL(M);const i=(a.getMetadata("exif")||{}).orientation||-1,n=imageToImageData(e,i,y);if(!f.length)return void v(n,{quality:p,type:x||t.type});const o=s(TransformWorker);o.post({transforms:f,imageData:n},e=>{v(objectToImageData(e),{quality:p,type:x||t.type}),o.terminate()},[n.data.buffer])})})),{options:{allowImageTransform:[!0,i.BOOLEAN],imageTransformOutputMimeType:[null,i.STRING],imageTransformOutputQuality:[null,i.INT],imageTransformOutputQualityMode:["always",i.STRING]}}};const isBrowser="undefined"!=typeof window&&void 0!==window.document;isBrowser&&document&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:plugin$1}));export default plugin$1;