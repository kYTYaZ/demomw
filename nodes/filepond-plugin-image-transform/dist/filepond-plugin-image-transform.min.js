/*
 * FilePondPluginImageTransform 3.0.1
 * Licensed under MIT, https://opensource.org/licenses/MIT
 * Please visit https://pqina.nl/filepond for details.
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.FilePondPluginImageTransform=e()}(this,function(){"use strict";var i={1:function(){return[1,0,0,1,0,0]},2:function(t){return[-1,0,0,1,t,0]},3:function(t,e){return[-1,0,0,-1,t,e]},4:function(t,e){return[1,0,0,-1,0,e]},5:function(){return[0,1,1,0,0,0]},6:function(t,e){return[0,1,-1,0,e,0]},7:function(t,e){return[0,-1,-1,0,e,t]},8:function(t){return[0,-1,1,0,0,t]}},m=function(t,e,n,a){-1!==a&&t.transform.apply(t,function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}(i[a](e,n)))},w=function(t,e){return{x:t,y:e}},o=function(t,e){return w(t.x-e.x,t.y-e.y)},y=function(t,e){return Math.sqrt((i=o(n=t,a=e),r=o(n,a),i.x*r.x+i.y*r.y));var n,a,i,r},x=function(t,e){var n=t,a=e,i=1.5707963267948966-e,r=Math.sin(1.5707963267948966),o=Math.sin(a),h=Math.sin(i),u=Math.cos(i),l=n/r;return w(u*(l*o),u*(l*h))},O=function(t,e){var n,a,i,r,o,h,u,l,d,g=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,s=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{x:.5,y:.5},c=.5<s.x?1-s.x:s.x,f=.5<s.y?1-s.y:s.y,m=2*c*t.width,v=2*f*t.height,p=(a=g,i=(n=e).width,r=n.height,o=x(i,a),h=x(r,a),u=w(n.x+Math.abs(o.x),n.y-Math.abs(o.y)),l=w(n.x+n.width+Math.abs(h.y),n.y+Math.abs(h.x)),d=w(n.x-Math.abs(h.y),n.y+n.height-Math.abs(h.x)),{width:y(u,l),height:y(u,d)});return Math.max(p.width/m,p.height/v)},P=function(t,e){var n=t.width,a=n*e;return a>t.height&&(n=(a=t.height)/e),{x:.5*(t.width-n),y:.5*(t.height-a),width:n,height:a}},v=function(t){return t&&(t.horizontal||t.vertical)},T=function(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},a=function(t,e,n){if(!e&&!v(n))return t.width=t.naturalWidth,t.height=t.naturalHeight,t;var a=document.createElement("canvas"),i=t.naturalWidth,r=t.naturalHeight;a.height=5<=e&&e<=8?(a.width=r,i):(a.width=i,r);var o=a.getContext("2d");return e&&(o.save(),m(o,i,r,e),o.restore()),v(n)&&(o.translate(.5*a.width,.5*a.height),o.scale(n.horizontal?-1:1,n.vertical?-1:1),o.translate(.5*-a.width,.5*-a.height)),o.drawImage(t,0,0,i,r),a}(t,e,n.flip),i={width:a.width,height:a.height},r=document.createElement("canvas"),o=n.aspectRatio||i.height/i.width,h=function(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1,a=t.height/t.width,i=e,r=1,o=a;i<o&&(r=(o=i)/a);var h=Math.max(1/r,i/o),u=t.width/(n*r*h),l=u*e;return{width:Math.round(u),height:Math.round(l)}}(i,o,n.zoom);r.width=h.width,r.height=h.height;var u={x:.5*r.width,y:.5*r.height},l=u.x-i.width*(n.center?n.center.x:.5),d=u.y-i.height*(n.center?n.center.y:.5),g={x:0,y:0,width:r.width,height:r.height,center:u},s=O(i,P(g,o),n.rotation,n.center),c=(n.zoom||1)*s,f=r.getContext("2d");return f.translate(u.x,u.y),f.rotate(n.rotation||0),f.scale(c,c),f.drawImage(a,l-u.x,d-u.y,i.width,i.height),f.getImageData(0,0,r.width,r.height)},b=function(){var i={resize:function(t,e){var n=e.mode,a=e.upscale,i=e.size,r=i.width,o=i.height;null===r?r=o:null===o&&(o=r);if("force"!==n){var h=r/t.width,u=o/t.height,l=1;if("cover"===n?l=Math.max(h,u):"contain"===n&&(l=Math.min(h,u)),1<l&&!1===a)return t;r=t.width*l,o=t.height*l}for(var d=t.width,g=t.height,s=Math.round(r),c=Math.round(o),f=t.data,m=new Uint8ClampedArray(s*c*4),v=d/s,p=g/c,w=Math.ceil(v/2),y=Math.ceil(p/2),x=0;x<c;x++)for(var M=0;M<s;M++){for(var T=4*(M+x*s),b=0,A=0,_=0,E=gx_g=gx_b=gx_a=0,I=(x+.5)*p,R=Math.floor(x*p);R<(x+1)*p;R++)for(var F=Math.abs(I-(R+.5))/y,O=(M+.5)*v,P=F*F,U=Math.floor(M*v);U<(M+1)*v;U++){var L=Math.abs(O-(U+.5))/w,C=Math.sqrt(P+L*L);-1<=C&&C<=1&&0<(b=2*C*C*C-3*C*C+1)&&(L=4*(U+R*d),gx_a+=b*f[L+3],_+=b,f[L+3]<255&&(b=b*f[L+3]/250),E+=b*f[L],gx_g+=b*f[L+1],gx_b+=b*f[L+2],A+=b)}m[T]=E/A,m[T+1]=gx_g/A,m[T+2]=gx_b/A,m[T+3]=gx_a/_}return{data:m,width:s,height:c}}},t=function(t,e){var n,a;e((n=t.transforms,a=t.imageData,n.forEach(function(t){a=i[t.type](a,t.data)}),a))};self.onmessage=function(e){t(e.data.message,function(t){self.postMessage({id:e.data.id,message:t},[t.data.buffer])})}};HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(i,r,o){var h=this;setTimeout(function(){for(var t=h.toDataURL(r,o).split(",")[1],e=atob(t),n=e.length,a=new Uint8Array(n);n--;)a[n]=e.charCodeAt(n);i(new Blob([a],{type:r||"image/png"}))})}});var t=function(t){var e=t.addFilter,n=t.utils,a=n.Type,c=n.forin,f=n.loadImage,m=n.getFileFromBlob,v=n.getFilenameWithoutExtension,p=n.createWorker,w=n.createBlob,y=n.renameFile,x=n.isFile,M=["resize"];return e("PREPARE_OUTPUT",function(g,t){var a=t.query,s=t.item;return new Promise(function(r,t){if(!x(g)||!/^image/.test(g.type)||!a("GET_ALLOW_IMAGE_TRANSFORM"))return r(g);var e=a("GET_IMAGE_TRANSFORM_OUTPUT_QUALITY"),i=null===e?null:e/100,n=a("GET_IMAGE_TRANSFORM_OUTPUT_QUALITY_MODE"),o=a("GET_IMAGE_TRANSFORM_OUTPUT_MIME_TYPE"),h=s.getMetadata().crop,u=[];if(c(s.getMetadata(),function(t,e){M.includes(t)&&u.push({type:t,data:e})}),(null===i||null!==i&&"optional"===n)&&null===o&&!h&&!u.length)return r(g);var R,F,l=function(t,e){var a,i;(a=t,i=e,new Promise(function(t,e){var n=document.createElement("canvas");n.width=a.width,n.height=a.height,n.getContext("2d").putImageData(a,0,0),n.toBlob(t,i.type,i.quality)})).then(function(t){var e,n,a,i=m(t,(e=g.name,a=t.type,n="image/jpeg"===a||"image/png"===a?a:"image/jpeg",v(e)+"."+("image/jpeg"===n?"jpg":n.split("/")[1])));r(i)}).catch(function(t){console.error(t)})},d=URL.createObjectURL(g);if(/svg/.test(g.type)&&null===o)return h?void(R=g,F=h,new Promise(function(E,t){var I=new FileReader;I.onloadend=function(){var t=I.result,e=document.createElement("div");e.style.cssText="position:absolute;pointer-events:none;width:0;height:0;visibility:hidden;",e.innerHTML=t;var n=e.querySelector("svg");document.body.appendChild(e);var a=n.getBBox();e.parentNode.removeChild(e);var i=e.querySelector("title"),r=n.getAttribute("viewBox")||"",o=n.getAttribute("width")||"",h=n.getAttribute("height")||"",u=parseFloat(o)||null,l=parseFloat(h)||null,d=(o.match(/[a-z]+/)||[])[0]||"",g=(h.match(/[a-z]+/)||[])[0]||"",s=r.split(" ").map(parseFloat),c=s.length?{x:s[0],y:s[1],width:s[2],height:s[3]}:a,f=null!=u?u:c.width,m=null!=l?l:c.height;n.style.overflow="visible",n.setAttribute("width",f),n.setAttribute("height",m);var v=F.aspectRatio||m/f,p=f,w=p*v,y=O({width:f,height:m},P({width:p,height:w},v),F.rotation,F.center),x=F.zoom*y,M=.5*p,T=.5*w,b=["rotate("+F.rotation*(180/Math.PI)+" "+M+" "+T+")","translate("+M+" "+T+")","scale("+x+")","translate("+-M+" "+-T+")","translate("+(M-f*F.center.x)+" "+(T-m*F.center.y)+")"],A=["scale("+(F.flip.horizontal?-1:1)+" "+(F.flip.vertical?-1:1)+")","translate("+(F.flip.horizontal?-f:0)+" "+(F.flip.vertical?-m:0)+")"],_='<?xml version="1.0" encoding="UTF-8"?>\n<svg width="'+p+d+'" height="'+w+g+'" \nviewBox="0 0 '+p+" "+w+'" \npreserveAspectRatio="xMinYMin"\nxmlns="http://www.w3.org/2000/svg">\n\x3c!-- Generator: FilePond Image Transform Plugin - https://pqina.nl/filepond --\x3e\n<title>'+(i?i.textContent:R.name)+'</title>\n<desc>Cropped with FilePond.</desc>\n<g transform="'+b.join(" ")+'">\n<g transform="'+A.join(" ")+'">\n'+n.outerHTML+"\n</g>\n</g>\n</svg>";E(_)},I.readAsText(R)})).then(function(t){r(y(w(t,"image/svg+xml"),g.name))}):r(g);f(d).then(function(t){URL.revokeObjectURL(d);var e=(s.getMetadata("exif")||{}).orientation||-1,n=T(t,e,h);if(u.length){var a=p(b);a.post({transforms:u,imageData:n},function(t){l(function(e){var n=void 0;try{n=new ImageData(e.width,e.height)}catch(t){n=document.createElement("canvas").getContext("2d").createImageData(e.width,e.height)}return n.data.set(e.data),n}(t),{quality:i,type:o||g.type}),a.terminate()},[n.data.buffer])}else l(n,{quality:i,type:o||g.type})})})}),{options:{allowImageTransform:[!0,a.BOOLEAN],imageTransformOutputMimeType:[null,a.STRING],imageTransformOutputQuality:[null,a.INT],imageTransformOutputQualityMode:["always",a.STRING]}}};return"undefined"!=typeof window&&void 0!==window.document&&document&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:t})),t});